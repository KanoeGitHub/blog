---
title: "WindowsとMacでのディスプレイ拡大率とブラウザ拡大率の違いにハマった話"
date: 2025-08-27
categories:
- "programming"
tags: [
"ソフトウェア" 
]
menu:
  main:
    name: Basic Elements
    weight: 4
slug: 
slug: 20250827
---

## はじめに
Chrome拡張機能を自作していて、要素をスクリーンショットとしてキャプチャする処理を書いていたところ、**WindowsとMacで挙動が異なる問題**に遭遇しました。  
同じコードでも **Windowsでは正しくキャプチャできないケース** があり、調べてみると「ディスプレイの拡大率」と「ブラウザのズーム倍率」の扱いがOSごとに違うのが原因でした。

本記事では、私がハマった経緯と、最終的にどのように対処したかを紹介します。

---

## 背景
今回のコードは、任意のDOM要素をキャプチャするために `canvas` を使ってスクリーンショットを生成するものです。  
GitHubに公開している拡張はこちらです：

- [scroll_element_capture (GitHub)](https://github.com/KanoeGitHub/scroll_element_capture)

キャプチャのために要素の座標やサイズを計算するのですが、**環境によって微妙にズレが生じる**ことがありました。

---

## 問題の発生
試した環境は以下の通りです：

- **Mac**: ディスプレイの拡大率 = 100%、ブラウザのズーム倍率 = 100% → 問題なし
- **Windows**: ディスプレイの拡大率 = 150%、ブラウザのズーム倍率 = 100% → キャプチャ位置がずれる

つまり、**Windowsではシステム側の拡大率（DPIスケーリング）が影響する**のです。

---

## 調査結果
JavaScriptから取得できる値を確認したところ：

- `window.devicePixelRatio`  
  → OSの拡大率（DPIスケーリング）を反映
- `chrome.tabs.getZoom()` や `window.visualViewport.scale`  
  → ブラウザのズーム倍率を反映

Macの場合は「ディスプレイ拡大率 = 100% 固定」なのでズレは起こりませんが、Windowsは **OS側の拡大率とブラウザズームの両方が絡む**ため、計算を分ける必要があることがわかりました。

---

## 対応方法
最終的に、**Windows環境ではOSの拡大率を考慮して計算**するように修正しました。  
該当部分のコードは以下のようにしています（抜粋）：

```javascript
const scale = window.devicePixelRatio;
const zoom = await new Promise(resolve => {
  chrome.tabs.getZoom(z => resolve(z));
});

// Windowsの場合は両方を掛け合わせて補正
const effectiveScale = (isWindows ? scale * zoom : zoom);
```

これで、WindowsでもMacでもズレなくキャプチャできるようになりました。

## まとめ
- Macではディスプレイの拡大率は常に100%、ズーム倍率のみ考慮すればOK
- Windowsではディスプレイ拡大率とズーム倍率の両方を考慮する必要あり
- devicePixelRatio と chrome.tabs.getZoom() を組み合わせれば解決可能

小さな違いですが、クロスプラットフォーム対応を考えると意外と重要なポイントでした。
同じように「スクショがズレる…」と悩んでいる方の参考になれば幸いです。

## 参考
- [scroll_element_capture (Chrome Web Store)](https://chromewebstore.google.com/detail/scroll-element-capture/gihcgmefokbbpmchkeihmccccjmcfcmo)
- [scroll_element_capture (GitHub)](https://github.com/KanoeGitHub/scroll_element_capture)